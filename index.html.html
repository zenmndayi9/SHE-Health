<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#E8766D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="S.H.E Tracker">
    <title>S.H.E Body Measurement Tracker</title>
    <link rel="manifest" href="#" id="manifest-placeholder">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #ffffff;
        }
        .she-coral {
            color: #E8766D;
        }
        .she-coral-bg {
            background-color: #E8766D;
        }
        .she-coral-light {
            background-color: #FEF0EF;
        }
        .she-coral-border {
            border-color: #E8766D;
        }
        .she-button {
            background-color: #E8766D;
            transition: all 0.3s;
        }
        .she-button:hover {
            background-color: #D66960;
        }
        .she-focus:focus {
            outline: none;
            border-color: #E8766D;
            box-shadow: 0 0 0 3px rgba(232, 118, 109, 0.1);
        }
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 90%;
        }
        @media (display-mode: standalone) {
            .install-prompt {
                display: none !important;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-white p-4">
    <!-- Install Prompt -->
    <div id="install-prompt" class="install-prompt hidden">
        <div class="she-coral-bg text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4">
            <div class="flex-1">
                <p class="font-bold">Install S.H.E Tracker</p>
                <p class="text-sm opacity-90">Add to home screen for easy access</p>
            </div>
            <button onclick="app.installApp()" class="bg-white she-coral px-4 py-2 rounded-lg font-bold">
                Install
            </button>
            <button onclick="app.dismissInstall()" class="text-white opacity-75 hover:opacity-100">
                ✕
            </button>
        </div>
    </div>

    <div id="app"></div>

    <script>
        // Create manifest dynamically
        const manifestData = {
            "name": "S.H.E Body Measurement Tracker",
            "short_name": "S.H.E Tracker",
            "description": "Sisterhood • Healing • Elevation - Track your wellness journey",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#E8766D",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23E8766D'/%3E%3Ctext x='96' y='110' font-family='serif' font-size='80' font-weight='bold' fill='white' text-anchor='middle'%3ES.H.E%3C/text%3E%3C/svg%3E",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23E8766D'/%3E%3Ctext x='256' y='300' font-family='serif' font-size='200' font-weight='bold' fill='white' text-anchor='middle'%3ES.H.E%3C/text%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'she-tracker-v1';
                    
                    self.addEventListener('install', (event) => {
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', (event) => {
                        event.waitUntil(clients.claim());
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const swBlob = new Blob([swCode], {type: 'application/javascript'});
                const swURL = URL.createObjectURL(swBlob);
                
                navigator.serviceWorker.register(swURL)
                    .then(() => console.log('Service Worker registered'))
                    .catch((err) => console.log('Service Worker registration failed:', err));
            });
        }

        // SVG Icons as strings
        const icons = {
            plus: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            trendingDown: '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>',
            calendar: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            ruler: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"></path><path d="m14.5 12.5 2-2"></path><path d="m11.5 9.5 2-2"></path><path d="m8.5 6.5 2-2"></path><path d="m17.5 15.5 2-2"></path></svg>',
            x: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            download: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>'
        };

        class MeasurementTracker {
            constructor() {
                this.measurements = [];
                this.showForm = false;
                this.formData = this.getEmptyFormData();
                this.deferredPrompt = null;
                this.loadData();
                this.setupInstallPrompt();
                this.render();
            }

            setupInstallPrompt() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    
                    // Only show if not dismissed before
                    if (!localStorage.getItem('she_install_dismissed')) {
                        setTimeout(() => {
                            document.getElementById('install-prompt').classList.remove('hidden');
                        }, 3000);
                    }
                });

                // Hide install prompt if already installed
                window.addEventListener('appinstalled', () => {
                    document.getElementById('install-prompt').classList.add('hidden');
                    this.deferredPrompt = null;
                });
            }

            async installApp() {
                if (!this.deferredPrompt) {
                    alert('To install: \n\n1. Tap the menu button (⋮) in your browser\n2. Select "Add to Home Screen" or "Install App"');
                    return;
                }

                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('App installed');
                }
                
                this.deferredPrompt = null;
                document.getElementById('install-prompt').classList.add('hidden');
            }

            dismissInstall() {
                document.getElementById('install-prompt').classList.add('hidden');
                localStorage.setItem('she_install_dismissed', 'true');
            }

            getEmptyFormData() {
                return {
                    date: new Date().toISOString().split('T')[0],
                    waist: '',
                    hips: '',
                    bust: '',
                    leftArm: '',
                    rightArm: '',
                    leftThigh: '',
                    rightThigh: '',
                    leftCalf: '',
                    rightCalf: '',
                    weight: '',
                    notes: ''
                };
            }

            loadData() {
                const stored = localStorage.getItem('she_measurements');
                if (stored) {
                    this.measurements = JSON.parse(stored);
                }
            }

            saveData() {
                localStorage.setItem('she_measurements', JSON.stringify(this.measurements));
            }

            handleSubmit() {
                const newEntry = {
                    id: Date.now(),
                    ...this.formData,
                    waist: parseFloat(this.formData.waist) || 0,
                    hips: parseFloat(this.formData.hips) || 0,
                    bust: parseFloat(this.formData.bust) || 0,
                    leftArm: parseFloat(this.formData.leftArm) || 0,
                    rightArm: parseFloat(this.formData.rightArm) || 0,
                    leftThigh: parseFloat(this.formData.leftThigh) || 0,
                    rightThigh: parseFloat(this.formData.rightThigh) || 0,
                    leftCalf: parseFloat(this.formData.leftCalf) || 0,
                    rightCalf: parseFloat(this.formData.rightCalf) || 0,
                    weight: parseFloat(this.formData.weight) || 0
                };

                this.measurements.push(newEntry);
                this.measurements.sort((a, b) => new Date(b.date) - new Date(a.date));
                this.saveData();
                
                this.formData = this.getEmptyFormData();
                this.showForm = false;
                this.render();
            }

            deleteEntry(id) {
                if (confirm('Are you sure you want to delete this entry?')) {
                    this.measurements = this.measurements.filter(m => m.id !== id);
                    this.saveData();
                    this.render();
                }
            }

            calculateLoss(current, initial) {
                if (!current || !initial) return null;
                const loss = initial - current;
                return loss > 0 ? loss.toFixed(1) : null;
            }

            getTotalLoss() {
                if (this.measurements.length < 2) return null;
                const latest = this.measurements[0];
                const initial = this.measurements[this.measurements.length - 1];
                
                const areas = ['waist', 'hips', 'bust', 'leftArm', 'rightArm', 'leftThigh', 'rightThigh', 'leftCalf', 'rightCalf'];
                let total = 0;
                areas.forEach(area => {
                    if (latest[area] && initial[area]) {
                        total += initial[area] - latest[area];
                    }
                });
                return total > 0 ? total.toFixed(1) : null;
            }

            render() {
                const app = document.getElementById('app');
                const totalLoss = this.getTotalLoss();
                const isInstalled = window.matchMedia('(display-mode: standalone)').matches;

                app.innerHTML = `
                    <div class="max-w-4xl mx-auto pb-20">
                        <!-- S.H.E Header -->
                        <div class="bg-white rounded-2xl shadow-lg p-8 mb-6 text-center border-2 she-coral-border">
                            <h1 class="text-4xl font-bold she-coral mb-2">S.H.E</h1>
                            <p class="she-coral text-sm font-medium tracking-widest mb-4">SISTERHOOD • HEALING • ELEVATION</p>
                            <h2 class="text-xl font-semibold text-gray-700">Body Measurement Tracker</h2>
                            ${!isInstalled ? `
                                <button onclick="app.installApp()" class="mt-4 she-button text-white px-4 py-2 rounded-lg flex items-center gap-2 font-medium mx-auto shadow-md">
                                    ${icons.download}
                                    Install as App
                                </button>
                            ` : '<p class="mt-4 text-sm text-gray-500">✓ Installed as app</p>'}
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                        <span class="she-coral">${icons.ruler}</span>
                                        Your Progress
                                    </h2>
                                </div>
                                <button onclick="app.toggleForm()" class="she-button text-white px-4 py-2 rounded-lg flex items-center gap-2 font-medium shadow-md">
                                    ${icons.plus}
                                    Add Entry
                                </button>
                            </div>

                            ${totalLoss ? `
                                <div class="she-coral-light rounded-xl p-4 flex items-center gap-3 border-2 she-coral-border">
                                    <span class="she-coral">${icons.trendingDown}</span>
                                    <div>
                                        <p class="text-sm text-gray-600">Total cm lost</p>
                                        <p class="text-3xl font-bold she-coral">${totalLoss} cm</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${this.showForm ? this.renderForm() : ''}
                        ${this.renderMeasurements()}
                    </div>
                `;
            }

            renderForm() {
                return `
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="date" value="${this.formData.date}" 
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg she-focus">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                ${this.renderInput('waist', 'Waist (cm)')}
                                ${this.renderInput('hips', 'Hips (cm)')}
                                ${this.renderInput('bust', 'Bust (cm)')}
                                ${this.renderInput('leftArm', 'Left Arm (cm)')}
                                ${this.renderInput('rightArm', 'Right Arm (cm)')}
                                ${this.renderInput('leftThigh', 'Left Thigh (cm)')}
                                ${this.renderInput('rightThigh', 'Right Thigh (cm)')}
                                ${this.renderInput('leftCalf', 'Left Calf (cm)')}
                                ${this.renderInput('rightCalf', 'Right Calf (cm)')}
                                ${this.renderInput('weight', 'Weight (kg)')}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                                <textarea id="notes" rows="3" 
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg she-focus"
                                    placeholder="How are you feeling? Any observations?">${this.formData.notes}</textarea>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="app.saveEntry()" 
                                    class="flex-1 she-button text-white py-3 rounded-lg font-medium shadow-md">
                                    Save Entry
                                </button>
                                <button onclick="app.toggleForm()" 
                                    class="px-6 py-3 border-2 she-coral-border rounded-lg hover:bg-gray-50 transition she-coral font-medium">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderInput(field, label) {
                return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                        <input type="number" step="0.1" id="${field}" value="${this.formData[field]}" 
                            placeholder="0.0"
                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg she-focus">
                    </div>
                `;
            }

            renderMeasurements() {
                if (this.measurements.length === 0) {
                    return `
                        <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
                            <div class="text-gray-300 mb-4">${icons.ruler}</div>
                            <p class="text-gray-600">No measurements yet. Add your first entry to start tracking!</p>
                        </div>
                    `;
                }

                const initial = this.measurements[this.measurements.length - 1];

                return `
                    <div class="space-y-4">
                        ${this.measurements.map((entry, index) => {
                            const isInitial = index === this.measurements.length - 1;
                            const date = new Date(entry.date);
                            const formattedDate = date.toLocaleDateString('en-ZA', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });

                            return `
                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-2">
                                            <span class="she-coral">${icons.calendar}</span>
                                            <span class="font-semibold text-gray-800">${formattedDate}</span>
                                            ${isInitial ? '<span class="text-xs she-coral-light she-coral px-3 py-1 rounded-full font-medium border she-coral-border">Starting Point</span>' : ''}
                                        </div>
                                        <button onclick="app.deleteEntry(${entry.id})" class="text-gray-400 hover:text-red-500 transition">
                                            ${icons.x}
                                        </button>
                                    </div>

                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        ${[
                                            { label: 'Waist', value: entry.waist, key: 'waist', unit: 'cm' },
                                            { label: 'Hips', value: entry.hips, key: 'hips', unit: 'cm' },
                                            { label: 'Bust', value: entry.bust, key: 'bust', unit: 'cm' },
                                            { label: 'Left Arm', value: entry.leftArm, key: 'leftArm', unit: 'cm' },
                                            { label: 'Right Arm', value: entry.rightArm, key: 'rightArm', unit: 'cm' },
                                            { label: 'Left Thigh', value: entry.leftThigh, key: 'leftThigh', unit: 'cm' },
                                            { label: 'Right Thigh', value: entry.rightThigh, key: 'rightThigh', unit: 'cm' },
                                            { label: 'Left Calf', value: entry.leftCalf, key: 'leftCalf', unit: 'cm' },
                                            { label: 'Right Calf', value: entry.rightCalf, key: 'rightCalf', unit: 'cm' },
                                            { label: 'Weight', value: entry.weight, key: 'weight', unit: 'kg' }
                                        ].map(item => {
                                            const loss = !isInitial ? this.calculateLoss(item.value, initial[item.key]) : null;
                                            
                                            return `
                                                <div class="bg-gray-50 rounded-lg p-3 border-2 border-transparent hover:she-coral-border transition">
                                                    <p class="text-xs text-gray-600 mb-1 font-medium">${item.label}</p>
                                                    <p class="text-2xl font-bold text-gray-800">
                                                        ${item.value || '-'} ${item.value ? item.unit : ''}
                                                    </p>
                                                    ${loss ? `<p class="text-sm she-coral font-bold mt-1">-${loss} ${item.unit} ✓</p>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>

                                    ${entry.notes ? `
                                        <div class="mt-4 she-coral-light rounded-lg p-4 border-2 she-coral-border">
                                            <p class="text-xs she-coral mb-2 font-bold uppercase tracking-wide">Notes</p>
                                            <p class="text-sm text-gray-700">${entry.notes}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            toggleForm() {
                this.showForm = !this.showForm;
                this.render();
            }

            saveEntry() {
                this.formData = {
                    date: document.getElementById('date').value,
                    waist: document.getElementById('waist').value,
                    hips: document.getElementById('hips').value,
                    bust: document.getElementById('bust').value,
                    leftArm: document.getElementById('leftArm').value,
                    rightArm: document.getElementById('rightArm').value,
                    leftThigh: document.getElementById('leftThigh').value,
                    rightThigh: document.getElementById('rightThigh').value,
                    leftCalf: document.getElementById('leftCalf').value,
                    rightCalf: document.getElementById('rightCalf').value,
                    weight: document.getElementById('weight').value,
                    notes: document.getElementById('notes').value
                };
                this.handleSubmit();
            }
        }

        // Create global app instance
        const app = new MeasurementTracker();
    </script>
</body>
</html>